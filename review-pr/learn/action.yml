name: "PR Review - Learn from Feedback"
description: "Process feedback on AI review comments and learn from corrections"
author: "Docker"

inputs:
  anthropic-api-key:
    description: "Anthropic API key"
    required: false
  openai-api-key:
    description: "OpenAI API key"
    required: false
  google-api-key:
    description: "Google API key for Gemini models"
    required: false
  aws-bearer-token-bedrock:
    description: "AWS Bearer token for Bedrock models"
    required: false
  xai-api-key:
    description: "xAI API key for Grok models"
    required: false
  nebius-api-key:
    description: "Nebius API key"
    required: false
  mistral-api-key:
    description: "Mistral API key"
    required: false
  github-token:
    description: "GitHub token for API access"
    required: false
  cagent-version:
    description: "Version of cagent to use"
    required: false
    default: "v1.19.7"
  model:
    description: "Model to use for processing feedback (e.g., anthropic/claude-haiku-4-5)"
    required: false
    default: ""

outputs:
  processed:
    description: "Whether feedback was processed (true if parent was an agent comment)"
    value: ${{ steps.check.outputs.is_agent }}

runs:
  using: "composite"
  steps:
    - name: Check if reply is to agent comment
      id: check
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token || github.token }}
        PARENT_ID: ${{ github.event.comment.in_reply_to_id }}
      run: |
        if [ -z "$PARENT_ID" ]; then
          echo "is_agent=false" >> $GITHUB_OUTPUT
          echo "â­ï¸ Not a reply comment, skipping"
          exit 0
        fi

        parent=$(gh api repos/${{ github.repository }}/pulls/comments/$PARENT_ID 2>/dev/null || echo "{}")
        if echo "$parent" | jq -r '.body // ""' | grep -q "<!-- cagent-review -->"; then
          echo "is_agent=true" >> $GITHUB_OUTPUT
          echo "âœ… Reply is to an agent review comment"
        else
          echo "is_agent=false" >> $GITHUB_OUTPUT
          echo "â­ï¸ Not a reply to agent comment, skipping"
        fi

    - name: Restore reviewer memory
      if: steps.check.outputs.is_agent == 'true'
      uses: actions/cache/restore@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
      with:
        path: ${{ github.workspace }}/.github/pr-review-memory.db
        key: pr-review-memory-${{ github.repository }}-${{ github.run_id }}
        restore-keys: |
          pr-review-memory-${{ github.repository }}-

    - name: Process feedback
      if: steps.check.outputs.is_agent == 'true'
      uses: docker/cagent-action@${{ github.action_ref || 'latest' }}
      with:
        agent: ${{ github.action_path }}/../agents/pr-review-feedback.yaml
        prompt: |
          A developer replied to your review comment with feedback.

          **File:** ${{ github.event.comment.path }}
          **Line:** ${{ github.event.comment.line }}
          **Their feedback:** ${{ github.event.comment.body }}

          Analyze this feedback:
          1. If they're correcting a false positive, add a memory to avoid this mistake
          2. If they're asking for clarification, note what was unclear
          3. If they're agreeing and adding context, store the additional insight

          Use add_memory to record what you learned, then react with ðŸ‘.
        anthropic-api-key: ${{ inputs.anthropic-api-key }}
        openai-api-key: ${{ inputs.openai-api-key }}
        google-api-key: ${{ inputs.google-api-key }}
        aws-bearer-token-bedrock: ${{ inputs.aws-bearer-token-bedrock }}
        xai-api-key: ${{ inputs.xai-api-key }}
        nebius-api-key: ${{ inputs.nebius-api-key }}
        mistral-api-key: ${{ inputs.mistral-api-key }}
        github-token: ${{ inputs.github-token }}
        cagent-version: ${{ inputs.cagent-version }}
        extra-args: ${{ inputs.model && format('--model={0}', inputs.model) || '' }}

    - name: Save reviewer memory
      if: steps.check.outputs.is_agent == 'true' && always()
      uses: actions/cache/save@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
      with:
        path: ${{ github.workspace }}/.github/pr-review-memory.db
        key: pr-review-memory-${{ github.repository }}-${{ github.run_id }}

    - name: Clean up old memory caches
      if: steps.check.outputs.is_agent == 'true' && always()
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token || github.token }}
      run: |
        # Keep the 5 most recent caches, delete older ones
        # This prevents proliferation while handling concurrent runs safely
        CACHE_PREFIX="pr-review-memory-${{ github.repository }}-"

        echo "ðŸ§¹ Cleaning up old memory caches (keeping 5 most recent)"

        # Get caches older than the 5 most recent (sorted by created_at descending, skip first 5)
        OLD_CACHES=$(gh api "repos/${{ github.repository }}/actions/caches" \
          --jq "[.actions_caches | map(select(.key | startswith(\"$CACHE_PREFIX\"))) | sort_by(.created_at) | reverse | .[5:] | .[].id] | .[]" \
          2>/dev/null || echo "")

        if [ -z "$OLD_CACHES" ]; then
          echo "âœ… No old caches to clean up"
          exit 0
        fi

        # Delete each old cache
        DELETED=0
        for CACHE_ID in $OLD_CACHES; do
          if gh api "repos/${{ github.repository }}/actions/caches/$CACHE_ID" -X DELETE 2>/dev/null; then
            ((DELETED++))
          fi
        done

        echo "âœ… Deleted $DELETED old cache(s)"
