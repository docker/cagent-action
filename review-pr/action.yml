name: "PR Review with CAgent"
description: "AI-powered pull request review with automatic learning from feedback"
author: "Docker"

inputs:
  pr-number:
    description: "Pull request number to review (auto-detected from github.event if not provided)"
    required: false
    default: ""
  comment-id:
    description: "Comment ID for reactions (auto-detected from github.event if not provided)"
    required: false
    default: ""
  additional-prompt:
    description: "Additional instructions appended to the review (e.g., language-specific patterns, project conventions)"
    required: false
    default: ""
  anthropic-api-key:
    description: "Anthropic API key"
    required: false
  openai-api-key:
    description: "OpenAI API key"
    required: false
  google-api-key:
    description: "Google API key for Gemini models"
    required: false
  aws-bearer-token-bedrock:
    description: "AWS Bearer token for Bedrock models"
    required: false
  xai-api-key:
    description: "xAI API key for Grok models"
    required: false
  nebius-api-key:
    description: "Nebius API key"
    required: false
  mistral-api-key:
    description: "Mistral API key"
    required: false
  github-token:
    description: "GitHub token for API access (overridden if github-app-id is provided)"
    required: false
  github-app-id:
    description: "GitHub App ID for custom app identity (comments/reviews will appear as the app)"
    required: false
  github-app-private-key:
    description: "GitHub App private key (required if github-app-id is provided)"
    required: false
  cagent-version:
    description: "Version of cagent to use"
    required: false
    default: "v1.19.7"
  model:
    description: "Model to use for reviews (e.g., anthropic/claude-sonnet-4-5, openai/gpt-4o)"
    required: false
    default: ""

outputs:
  exit-code:
    description: "Exit code from the review"
    value: ${{ steps.run-review.outputs.exit-code }}
  review-posted:
    description: "Whether a review was posted"
    value: ${{ steps.run-review.outputs.review-posted }}
  review-url:
    description: "URL to the posted review"
    value: ${{ steps.post-summary.outputs.review-url }}

runs:
  using: "composite"
  steps:
    # ========================================
    # SETUP
    # ========================================
    - name: Resolve PR number and comment ID
      id: resolve-context
      shell: bash
      run: |
        # Resolve PR number: input > pull_request event > issue event
        PR_NUMBER="${{ inputs.pr-number }}"
        if [ -z "$PR_NUMBER" ]; then
          PR_NUMBER="${{ github.event.pull_request.number }}"
        fi
        if [ -z "$PR_NUMBER" ]; then
          PR_NUMBER="${{ github.event.issue.number }}"
        fi
        if [ -z "$PR_NUMBER" ]; then
          echo "âŒ Could not determine PR number. Provide pr-number input or trigger from a PR event."
          exit 1
        fi
        echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "âœ… Resolved PR number: $PR_NUMBER"

        # Resolve comment ID: input > comment event (optional, for reactions)
        COMMENT_ID="${{ inputs.comment-id }}"
        if [ -z "$COMMENT_ID" ]; then
          COMMENT_ID="${{ github.event.comment.id }}"
        fi
        echo "comment-id=$COMMENT_ID" >> $GITHUB_OUTPUT
        if [ -n "$COMMENT_ID" ]; then
          echo "âœ… Resolved comment ID: $COMMENT_ID"
        else
          echo "â„¹ï¸  No comment ID - reactions will be skipped"
        fi

    # Generate GitHub App token if credentials are provided
    # This allows comments/reviews to appear as the custom app instead of github-actions[bot]
    - name: Generate GitHub App token
      id: app-token
      if: inputs.github-app-id != ''
      uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2
      with:
        app_id: ${{ inputs.github-app-id }}
        private_key: ${{ inputs.github-app-private-key }}

    # Resolve which token to use: app token > explicit github-token > default github.token
    - name: Resolve GitHub token
      id: resolve-token
      shell: bash
      run: |
        if [ -n "$APP_TOKEN" ]; then
          echo "âœ… Using GitHub App token"
          echo "token=$APP_TOKEN" >> $GITHUB_OUTPUT
        elif [ -n "$EXPLICIT_TOKEN" ]; then
          echo "âœ… Using provided github-token"
          echo "token=$EXPLICIT_TOKEN" >> $GITHUB_OUTPUT
        else
          echo "â„¹ï¸  Using default github.token"
          echo "token=$DEFAULT_TOKEN" >> $GITHUB_OUTPUT
        fi
      env:
        APP_TOKEN: ${{ steps.app-token.outputs.token }}
        EXPLICIT_TOKEN: ${{ inputs.github-token }}
        DEFAULT_TOKEN: ${{ github.token }}

    - name: Add eyes reaction
      if: steps.resolve-context.outputs.comment-id != ''
      shell: bash
      env:
        GH_TOKEN: ${{ steps.resolve-token.outputs.token }}
      run: |
        gh api repos/${{ github.repository }}/issues/comments/${{ steps.resolve-context.outputs.comment-id }}/reactions \
          -X POST -f content='eyes' || true

    - name: Get PR information
      id: pr-info
      shell: bash
      env:
        GH_TOKEN: ${{ steps.resolve-token.outputs.token }}
        PR_NUMBER: ${{ steps.resolve-context.outputs.pr-number }}
      run: |
        gh pr view $PR_NUMBER --json files -q '.files[].path' > changed_files.txt
        gh pr view $PR_NUMBER --json title,body,author,baseRefName,headRefName > pr_metadata.json
        echo "files_count=$(wc -l < changed_files.txt | tr -d ' ')" >> $GITHUB_OUTPUT

    - name: Ensure cache directory exists
      shell: bash
      run: mkdir -p "${{ github.workspace }}/.cache"

    - name: Restore reviewer memory
      uses: actions/cache/restore@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
      with:
        path: ${{ github.workspace }}/.cache/pr-review-memory.db
        key: pr-review-memory-${{ github.repository }}-${{ github.run_id }}
        restore-keys: |
          pr-review-memory-${{ github.repository }}-

    - name: Build review context
      id: context
      shell: bash
      env:
        PR_NUMBER: ${{ steps.resolve-context.outputs.pr-number }}
        EXTRA_PROMPT: ${{ inputs.additional-prompt }}
        REPO: ${{ github.repository }}
      run: |
        title=$(jq -r '.title' pr_metadata.json)
        author=$(jq -r '.author.login' pr_metadata.json)
        body=$(jq -r '.body // "No description provided."' pr_metadata.json)
        base=$(jq -r '.baseRefName' pr_metadata.json)
        head=$(jq -r '.headRefName' pr_metadata.json)
        files_count=$(wc -l < changed_files.txt | tr -d ' ')

        # Build review context (using echo to avoid YAML heredoc parsing issues)
        {
          echo "# Pull Request Review Request"
          echo ""
          echo "## PR Information"
          echo "- **URL**: https://github.com/${REPO}/pull/${PR_NUMBER}"
          echo "- **Title**: $title"
          echo "- **Author**: $author"
          echo "- **Branch**: $head â†’ $base"
          echo "- **Files Changed**: $files_count"
          echo ""
          echo "## PR Description"
          echo "$body"
          echo ""
          echo "## Changed Files"
          echo ""
          cat changed_files.txt
          echo ""
          echo "---"
          echo ""
          echo "## Instructions"
          echo ""
          echo "Execute the review pipeline:"
          echo ""
          echo '1. **Gather**: Use `gh pr diff` to get the full diff'
          echo '2. **Draft**: Delegate to `drafter` agent to generate bug hypotheses'
          echo '3. **Verify**: For each hypothesis, delegate to `verifier` agent'
          echo '4. **Post**: Aggregate findings and post review via `gh api`'
          echo ""
          echo "Only report CONFIRMED and LIKELY findings. Approve if no issues found."
        } > review_context.md

        # Append extra prompt if provided
        if [ -n "$EXTRA_PROMPT" ]; then
          {
            echo ""
            echo "## Additional Guidelines"
            echo ""
            echo "$EXTRA_PROMPT"
          } >> review_context.md
        fi

        # Save prompt to output for the action
        {
          echo "review_prompt<<PROMPT_EOF"
          cat review_context.md
          echo "PROMPT_EOF"
        } >> $GITHUB_OUTPUT

    # ========================================
    # RUN REVIEW using root cagent-action
    # ========================================
    - name: Run PR Review
      id: run-review
      uses: docker/cagent-action@latest
      with:
        agent: ${{ github.action_path }}/agents/pr-review.yaml
        prompt: ${{ steps.context.outputs.review_prompt }}
        anthropic-api-key: ${{ inputs.anthropic-api-key }}
        openai-api-key: ${{ inputs.openai-api-key }}
        google-api-key: ${{ inputs.google-api-key }}
        aws-bearer-token-bedrock: ${{ inputs.aws-bearer-token-bedrock }}
        xai-api-key: ${{ inputs.xai-api-key }}
        nebius-api-key: ${{ inputs.nebius-api-key }}
        mistral-api-key: ${{ inputs.mistral-api-key }}
        github-token: ${{ steps.resolve-token.outputs.token }}
        cagent-version: ${{ inputs.cagent-version }}
        extra-args: ${{ inputs.model && format('--model={0}', inputs.model) || '' }}

    - name: Save reviewer memory
      if: always()
      uses: actions/cache/save@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
      with:
        path: ${{ github.workspace }}/.cache/pr-review-memory.db
        key: pr-review-memory-${{ github.repository }}-${{ github.run_id }}

    - name: Clean up old memory caches
      if: always()
      shell: bash
      env:
        GH_TOKEN: ${{ steps.resolve-token.outputs.token }}
      run: |
        # Keep the 5 most recent caches, delete older ones
        # This prevents proliferation while handling concurrent runs safely
        CACHE_PREFIX="pr-review-memory-${{ github.repository }}-"

        echo "ðŸ§¹ Cleaning up old memory caches (keeping 5 most recent)"

        # Get caches older than the 5 most recent (sorted by created_at descending, skip first 5)
        OLD_CACHES=$(gh api "repos/${{ github.repository }}/actions/caches" \
          --jq "[.actions_caches | map(select(.key | startswith(\"$CACHE_PREFIX\"))) | sort_by(.created_at) | reverse | .[5:] | .[].id] | .[]" \
          2>/dev/null || echo "")

        if [ -z "$OLD_CACHES" ]; then
          echo "âœ… No old caches to clean up"
          exit 0
        fi

        # Delete each old cache
        DELETED=0
        for CACHE_ID in $OLD_CACHES; do
          if gh api "repos/${{ github.repository }}/actions/caches/$CACHE_ID" -X DELETE 2>/dev/null; then
            ((DELETED++))
          fi
        done

        echo "âœ… Deleted $DELETED old cache(s)"

    # ========================================
    # POST-REVIEW: Clean summary & reactions
    # ========================================
    - name: Post clean summary
      id: post-summary
      if: always()
      shell: bash
      env:
        PR_NUMBER: ${{ steps.resolve-context.outputs.pr-number }}
        REPOSITORY: ${{ github.repository }}
        EXIT_CODE: ${{ steps.run-review.outputs.exit-code }}
      run: |
        REVIEW_URL="https://github.com/$REPOSITORY/pull/$PR_NUMBER"
        echo "review-url=$REVIEW_URL" >> $GITHUB_OUTPUT

        # Override the default summary with a cleaner one for PR reviews
        {
          echo ""
          echo "---"
          echo ""
          echo "## PR Review Summary"
          echo ""
          if [ "$EXIT_CODE" == "0" ]; then
            echo "âœ… **Review posted successfully**"
          else
            echo "âŒ **Review failed** (exit code: $EXIT_CODE)"
          fi
          echo ""
          echo "ðŸ“ [View Pull Request #$PR_NUMBER]($REVIEW_URL)"
        } >> $GITHUB_STEP_SUMMARY

    - name: Add completion reaction
      if: steps.resolve-context.outputs.comment-id != '' && always()
      shell: bash
      env:
        GH_TOKEN: ${{ steps.resolve-token.outputs.token }}
        EXIT_CODE: ${{ steps.run-review.outputs.exit-code }}
        PR_NUMBER: ${{ steps.resolve-context.outputs.pr-number }}
      run: |
        if [ "$EXIT_CODE" != "0" ]; then
          # Error: add confused reaction
          gh api "repos/${{ github.repository }}/issues/comments/${{ steps.resolve-context.outputs.comment-id }}/reactions" \
            -X POST -f content='confused' || true
          exit 0
        fi

        # Get the latest review state from the PR (use last? to handle empty arrays safely)
        REVIEW_STATE=$(gh api "repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" \
          --jq '[.[] | select(.user.type == "Bot")] | last? | .state? // empty' 2>/dev/null || echo "")

        if [ "$REVIEW_STATE" == "APPROVED" ]; then
          # Approved: thumbs up
          gh api "repos/${{ github.repository }}/issues/comments/${{ steps.resolve-context.outputs.comment-id }}/reactions" \
            -X POST -f content='+1' || true
        fi
        # Changes requested: no reaction (the review itself is the feedback)
